#!/usr/bin/env php
<?php

$RED   = "\033[0;31m";
$GREEN = "\033[0;32m";
$YELLOW = "\033[0;33m";
$NC    = "\033[0m";

// Filter argv to only keep positional arguments
$positional = array_values(array_filter($argv, function($arg){
    return strpos($arg, '--') !== 0 && strpos($arg, '-') !== 0;
}));

$params = [];
foreach ($argv as $arg) {
    if (strpos($arg, '--') === 0) {
        $params[] = substr($arg, 2);
    }
}

$create=in_array('create', $params);
$argv=$positional;

/*
    Help / Documentation
*/

if (count($positional) < 2 || isset($options['help']) || isset($options['h'])) {
    echo "{$GREEN}UHO-MVC Schema Builder{$NC}\n\n";
    echo "{$YELLOW}Usage:{$NC}\n";
    echo "  schema-build <env-file> [schemas.json|path] [output-path] [options]\n\n";
    echo "{$YELLOW}Arguments:{$NC}\n";
    echo "  {$GREEN}<env-file>{$NC}        Path to .env file containing database credentials\n";
    echo "                   Required variables: SQL_HOST, SQL_BASE, SQL_USER, SQL_PASS\n\n";
    echo "  {$GREEN}[schemas.json]{$NC}    (Optional) Path to JSON file with schema definitions\n";
    echo "                   If not provided, scans application/models/json/*.json\n\n";
    echo "  {$GREEN}[path]{$NC}            (Optional) Directory containing JSON schema files\n";
    echo "                   Default: application/models/json/\n\n";
    echo "{$YELLOW}Options:{$NC}\n";
    echo "  {$GREEN}--create{$NC}          Automatically create/update tables in database\n";
    echo "                   Without this flag, only shows what would be changed\n\n";
    echo "  {$GREEN}--verbose{$NC}         Show detailed output\n\n";
    echo "  {$GREEN}--help, -h{$NC}        Show this help message\n\n";
    echo "{$YELLOW}Examples:{$NC}\n";
    echo "  schema-build .env\n";
    echo "  schema-build .env --create\n";
    echo "  schema-build .env schemas.json\n";
    echo "  schema-build .env application/models/json/\n";
    echo "  schema-build .env schemas.json output/path/ --create\n\n";
    exit(0);
}

echo "\n{$GREEN}UHO-MVC Schema Builder{$NC}\n\n";
$root = $_SERVER['DOCUMENT_ROOT'] = $_SERVER['PWD'];
require $_SERVER['DOCUMENT_ROOT'] . '/vendor/autoload.php';

use Huncwot\UhoFramework\_uho_orm;
use Huncwot\UhoFramework\_uho_load_env;
use Huncwot\UhoFramework\_uho_mysqli;

function validate_env() {}

/*
    Env read
*/

$env_path = @$argv[1];
if (!$env_path || !file_exists($root . '/' . $env_path)) {
    echo "{$RED}Error:{$NC} ENV file not found: $env_path\n";
    echo "Run 'schema-build --help' for usage information.\n";
    exit(1);
}

$env_loader = new _uho_load_env($root . '/' . $env_path);
$env_loader->load();

$required = ['SQL_HOST', 'SQL_BASE', 'SQL_USER', 'SQL_PASS'];

foreach ($required as $req) {
    if (!getenv($req)) {
        echo ("Error: required env variable missing: $req\n");
        exit(1);
    }
}

/*
    Schemas read
*/

$path = $root . '/application/models/json';

// json file
if (isset($argv[2]) && strpos($argv[2], '.json') !== false)
{
    $schemas = @file_get_contents($root . '/' . $argv[2]);
    if (!$schemas) {
        echo ('Schemas file not found: ' . $root . '/' . $argv[2]);
        exit(1);
    }
    $schemas = @json_decode($schemas, true);
    if (!$schemas) {
        echo ('JSON invalid in: ' . $root . '/' . $argv[2]);
        exit(1);
    }

    if (!empty($argv[3]))
        $path = $root.'/'.$argv[3];
    

} else {

    if (isset($argv[2]))    
        $path = $root . '/' . $argv[2];

    $files = glob($path . '/*.json');
    $analyzed=count($files);

    if (!$files) {
        echo ('No JSON files found in: ' . $path . '/');
        exit(1);
    }

    if ($files) {
        foreach ($files as $k => $file) {
            $files[$k] = explode('.', basename($file))[0];
        }
        
        $schemas = ['schemas' => $files];
    }
}

if (!$schemas) {
    echo 'Error: cannot read ' . $path . '/schemas.json, either no jsons found in ' . $path_original . " or invalid format.\n";
    exit(1);
}

$sql = new _uho_mysqli();
$sql->init(
    getenv('SQL_HOST'),
    getenv('SQL_USER'),
    getenv('SQL_PASS'),
    getenv('SQL_BASE')
);

$orm = new _uho_orm($sql, null, []);
$orm->setDebug(true);
$path=str_replace('//','/',$path.'/');
$orm->addRootPath($path);

$i = 0;
$e = 0;
$err = [];
$created = 0;
$updated = 0;

if ($create)
    $settings = ['create' => 'auto', 'update' => 'auto'];
    else
        $settings = ['create' => 'info', 'update' => 'info'];

$messages=[];

foreach ($schemas as $section => $list)
    foreach ($list as $schema) {
        $i++;

        if (is_array($schema))
        {
            if (!empty($schema['schema']) && !empty($schema['sql']))
            {
                $model = $schema['schema'];
                $settings['create_sql'] = $schema['sql'];
            } else {
                $err[] = 'Invalid schema object (schema/sql) definition in schemas.json in section [' . $section . ']';
                $model = null;
            }
        } else $model = $schema;

        if ($model) {
            /*
                Validation
            */
            $schema = $orm->getSchema($model, null, ['return_error' => true]);
            if (@$schema['result'] === false) $err[] = 'Schema definition not found: ' . $model;
            else {
                $response = $orm->validateSchema($schema);
                if ($response['errors']) {
                    $err[] = '*** Error in [' . $model . '] ::: ' . implode(', ', $response['errors']);
                } else
                /*
                    Create / Update
                */ {
                    $response = $orm->sqlCreator($schema, $settings);
                    $messages = array_merge($messages,$response['messages']);
                    if (in_array('table_update', $response['actions'])) $updated++;
                    if (in_array('table_create', $response['actions'])) $created++;
                }
            }
        }
    }


if ($messages)
{
    echo "{$YELLOW}Messages (".count($messages)."){$NC}\n\n";
    foreach ($messages as $nr => $message)
        echo ($nr+1).'. '. $message."\n";
    if (!$create) echo "\nUse --create to perform creation of missing schemas.\n";
    echo "\n";
}

if ($err)
{
    echo "{$RED}Errors occurred (".count($err)."){$NC}\n\n";
    foreach ($err as $nr => $error)
        echo ($nr+1).'. '. $error."\n";    
    echo "\n\n";
}

echo "Schemas (\e[31m" . count($err) . "\e[0m) invalid.\n";
echo "Schemas (\e[33m" . $created . "\e[0m) created.\n";
echo "Schemas (\e[32m" . $updated . "\e[0m) updated.\n";
echo "Schemas (\e[32m" . $analyzed . "\e[0m) analyzed.\n\n";

exit(0);
