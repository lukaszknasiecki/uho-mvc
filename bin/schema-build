#!/usr/bin/env php
<?php

echo "UHO-MVC builder...\n\n";
$_SERVER['DOCUMENT_ROOT'] = $_SERVER['PWD'];

require __DIR__ . '/../vendor/autoload.php';

use Huncwot\UhoFramework\_uho_orm;
use Huncwot\UhoFramework\_uho_load_env;
use Huncwot\UhoFramework\_uho_mysqli;

function validate_env()
{

}

/*
    Env read
*/
$env_path = $argv[1];
if (!$env_path || !file_exists($env_path)) exit('Env file not found');

$env_loader = new _uho_load_env($env_path);
$env_loader->load();

$required=['SQL_HOST', 'SQL_BASE', 'SQL_USER', 'SQL_PASS'];

foreach ($required as $req) {
    if (!getenv($req)) {
        exit("Error: required env variable missing: $req\n");
    }
}

/*
    Schemas read
*/

$path_original = $path = $argv[2] ?? __DIR__ . '/../../..';
$path .= '/application/models/';
$path = rtrim($path, '/');

$schemas = @json_decode(file_get_contents($path . '/schemas.json'), true);

if ($schemas) {
    $path .= 'json/';
} else {
    $files = glob($path_original . '/*.json');
    $path = $path_original;

    if ($files) {
        foreach ($files as $k => $file) {
            $files[$k] = explode('.', basename($file))[0];
        }
        $schemas = ['schemas' => $files];
    }
}

if (!$schemas)
    {
        echo 'Error: cannot read ' . $path . '/schemas.json, either no jsons found in ' . $path_original . " or invalid format.\n";
        exit(1);
    }

$sql = new _uho_mysqli();
$sql->init(
    getenv('SQL_HOST'),
    getenv('SQL_USER'),
    getenv('SQL_PASS'),
    getenv('SQL_BASE')
);

$orm = new _uho_orm(null, $sql, null, null, true);
$orm->addRootPath($path);

$i = 0;
$e = 0;
$err = [];
$created = 0;
$updated = 0;
$settings = ['create' => 'auto', 'update' => 'alert'];

foreach ($schemas as $section => $list)
    foreach ($list as $schema) {
        $i++;

        if (is_array($schema)) {
            if (!empty($schema['schema']) && !empty($schema['sql'])) {
                $model = $schema['schema'];
                $settings['create_sql'] = $schema['sql'];
            } else {
                $err[] = 'Invalid schema object (schema/sql) definition in schemas.json in section [' . $section . ']';
                $model = null;
            }
        } else $model = $schema;

        if ($model)
        {
            /*
                Validation
            */
            $schema = $orm->getSchema($model, null, ['return_error' => true]);
            if (@$schema['result'] === false) $err[] = 'Schema definition not found: ' . $model;
            else {
                $response = $orm->validateSchema($schema);
                if ($response['errors']) {
                    $err[] = '*** Error in [' . $model . '] ::: ' . implode(', ', $response['errors']);
                } else
                /*
                    Create / Update
                */
                {
                    $response=$orm->creator($schema, $settings);
                    if (in_array('table_update', $response['actions'])) $updated++;
                    if (in_array('table_create', $response['actions'])) $created++;
                    


                }
            }
        }
    }



if ($err)
    foreach ($err as $error)
        echo "$error\n";

echo "Schemas (\e[31m" . count($err) . "\e[0m) invalid.\n";
echo "Schemas (\e[33m" . $created . "\e[0m) created.\n";
echo "Schemas (\e[32m" . $updated . "\e[0m) updated.\n";
exit(0);
