#!/usr/bin/env php
<?php

$RED   = "\033[0;31m";
$GREEN = "\033[0;32m";
$YELLOW = "\033[0;33m";
$NC    = "\033[0m";

echo "-------------------\n";
echo "UHO-MVC validator...\n";
echo "-------------------\n\n";

$root = $_SERVER['DOCUMENT_ROOT'] = $_SERVER['PWD'];
require $_SERVER['DOCUMENT_ROOT'] . '/vendor/autoload.php';

use Huncwot\UhoFramework\_uho_orm;

/*
    if first argument is set it should point to application_config folder
    otherwise we will scrap application/models/ folder
*/

$path = $root.'/application/models/json';

if (!empty($argv[1]) && strpos($argv[1],'.json'))
{    
    $schemas = @file_get_contents($root .'/'. $argv[1]);

    if (!$schemas)
        {
            echo('Schemas file not found: '.$root . '/'.$argv[1]);
            exit(1);
        }

    $schemas = @json_decode($schemas,true);
    if (!$schemas)
        {
            echo('JSON invalid in: '.$root . '/'.$argv[1]);
            exit(1);
        }

    if (!empty($argv[2]))
        $path = $root.'/'.$argv[2];

}
 else {
    
     if (!empty($argv[1])) $path=$argv[1];

    $files = glob($path . '/*.json');

    if (!$files)
        {
            echo('No JSON files found in: '.$path . '/');
            exit(1);
        }

    if ($files) {
        foreach ($files as $k => $file) {
            $files[$k] = explode('.', basename($file))[0];
        }
        $schemas = ['schemas' => $files];
    }
}

$orm = new _uho_orm(null, null, [], true);
$orm->setDebug(true);
$orm->removeRootPaths();
$path=str_replace('//','/',$path.'/');

$orm->addRootPath($path);

$i = 0;
$e = 0;
$err = [];
$valid = 0;

foreach ($schemas as $section => $list)
    foreach ($list as $schema) {
        $i++;

        if (is_array($schema)) {
            if (!empty($schema['schema']) && !empty($schema['sql'])) {
                $model = $schema['schema'];
                $settings['create_sql'] = $schema['sql'];
            } else {
                $err[] = 'Invalid schema object (schema/sql) definition in schemas.json in section [' . $section . ']';
                $model = null;
            }
        } else $model = $schema;

        if ($model)
        {
            $schema = $orm->getSchema($model, null, ['return_error' => true]);
            if (@$schema['result'] === false) $err[] = $schema['message'];
            else {
                $response = $orm->validateSchema($schema);
                if ($response['errors']) {
                    $err[] = $YELLOW.'[' . $model . ']'.$NC.'[enter][enter]' . implode('[enter]', $response['errors']).'[enter]';
                } else $valid++;
            }
        }
    }

if ($err)
{
    echo "{$RED}Errors occurred (".count($err)."){$NC}\n\n";
    foreach ($err as $nr => $error)
    {
        echo "{$RED}".($nr+1)."."."{$NC}".' ';
        echo str_replace("[enter]","\n",$error)."\n";
    }
    echo "\n";
}
echo "Schemas (" . count($err) . ") invalid.\n";
echo "Schemas (" . $valid . ") valid.\n";
if (count($err)==0 && $valid>0) echo "{$GREEN}ALLGOOD{$NC}\n\n";
exit(0);
